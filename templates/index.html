<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ModStacker üõ†Ô∏è</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- –ù–∞—à JS -->
    <script src="/static/js/app.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .drag-over {
            border-color: #3b82f6 !important;
            background: rgba(59, 130, 246, 0.1) !important;
        }
        .dragging { opacity: 0.5; }

        /* –ë–µ–π–¥–∂–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è */
        .env-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        .env-client { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .env-server { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .env-both   { background: rgba(139, 92, 246, 0.2); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.3); }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen font-sans"
      x-data="app()" x-init="initApp()">

    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <div class="sticky top-0 z-50 bg-slate-800 border-b border-slate-700 shadow-lg p-4">
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 text-transparent bg-clip-text">
                <i class="fa-solid fa-cube"></i> ModStacker
            </h1>

            <div class="flex gap-2 items-center">
                <span class="text-xs text-slate-500" x-show="isSaving">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>
                <button @click="saveData()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-sm font-bold transition">
                    <i class="fa-solid fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏—è–º–∏ -->
        <div class="flex items-center gap-3 flex-wrap">
            <span class="text-sm text-slate-400 font-semibold">–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –≤–µ—Ä—Å–∏–∏:</span>

            <div class="flex gap-2 flex-wrap items-center">
                <template x-for="(ver, idx) in targetVersions" :key="ver">
                    <div class="flex items-center gap-1 bg-blue-600 px-2 py-1 rounded text-xs font-mono">
                        <span x-text="ver"></span>
                        <button @click="removeVersion(idx)" class="ml-1 text-blue-200 hover:text-white">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </template>

                <div class="flex gap-1 items-center">
                    <input type="text"
                           x-model="newVersion"
                           @keyup.enter="addVersion()"
                           placeholder="1.21.5"
                           class="w-20 bg-slate-700 border border-slate-600 rounded px-2 py-1 text-xs font-mono focus:border-blue-500 outline-none">
                    <button @click="addVersion()" class="bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-xs transition">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
            </div>

            <button @click="resetChecks()" class="ml-auto text-xs text-slate-500 hover:text-slate-300 transition">
                <i class="fa-solid fa-rotate"></i> –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏
            </button>
        </div>
    </div>

    <div class="container mx-auto p-6 flex gap-6 items-start">

        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –°–ø–∏—Å–æ–∫ –º–æ–¥–æ–≤ (—à–∏—Ä–æ–∫–∞—è) -->
        <div class="flex-1 space-y-6">

            <template x-for="(cat, catIndex) in data.categories" :key="catIndex">
                <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                    <div class="p-4 bg-slate-800/50 flex justify-between items-center border-b border-slate-700">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fa-solid fa-folder-open text-yellow-500"></i>
                            <input x-model="cat.name"
                                   @input="saveData()"
                                   class="bg-transparent outline-none focus:text-blue-400"
                                   placeholder="Category Name">
                        </h2>
                        <div class="flex gap-2 items-center">
                            <button @click="cat.showExport = !cat.showExport"
                                    class="text-blue-400 hover:text-blue-300 text-sm transition">
                                <i class="fa-solid fa-file-export"></i> Export
                            </button>
                            <button @click="deleteCategory(catIndex)"
                                    class="text-red-500 hover:text-red-400 opacity-50 hover:opacity-100">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- –ü–∞–Ω–µ–ª—å —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
                    <div x-show="cat.showExport"
                         x-collapse
                         class="p-4 bg-slate-900/50 border-b border-slate-700">
                        <div class="text-xs text-slate-500 mb-2 uppercase font-bold">
                            –°—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –º–æ–¥—ã –∏–∑ "<span x-text="cat.name"></span>"
                        </div>
                        <textarea readonly
                                  class="w-full h-24 bg-slate-900 rounded p-2 text-xs font-mono text-slate-400 border border-slate-700 resize-none focus:border-blue-500 outline-none"
                                  @click="$el.select()"
                                  x-text="exportCategory(cat)"></textarea>
                    </div>

                    <!-- –ó–æ–Ω–∞ –¥—Ä–æ–ø–∞ -->
                    <div class="p-2 space-y-1 min-h-[100px]"
                         @dragover.prevent="$el.classList.add('drag-over')"
                         @dragleave="$el.classList.remove('drag-over')"
                         @drop="handleDrop($event, catIndex); $el.classList.remove('drag-over')">

                        <template x-for="(mod, modIndex) in cat.mods" :key="mod.slug">
                            <div class="group flex items-center justify-between gap-3 p-3 rounded-lg hover:bg-slate-700 transition border border-transparent hover:border-slate-600 cursor-move"
                                 draggable="true"
                                 @dragstart="handleDragStart($event, catIndex, modIndex)"
                                 @dragend="$el.classList.remove('dragging')">

                                <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –∏–∫–æ–Ω–∫–∞ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å –±–µ–π–¥–∂–∞–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è -->
                                <div class="flex items-center gap-3 flex-shrink-0 min-w-0" style="width: 300px;">
                                    <i class="fa-solid fa-grip-vertical text-slate-600 group-hover:text-slate-500 cursor-grab active:cursor-grabbing flex-shrink-0"></i>
                                    <img :src="mod.icon_url || 'https://cdn.modrinth.com/data/AANobbMI/icon.png'"
                                         class="w-10 h-10 rounded bg-slate-800 object-cover flex-shrink-0">
                                    <div class="min-w-0 flex-1">
                                        <div class="font-bold leading-tight truncate" x-text="mod.title" :title="mod.title"></div>
                                        <div class="flex gap-1 mt-1 items-center flex-wrap">
                                            <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è -->
                                            <template x-if="getEnvType(mod) === 'client'">
                                                <span class="env-badge env-client" title="Client Side Only">
                                                    <i class="fa-solid fa-desktop"></i> Client
                                                </span>
                                            </template>
                                            <template x-if="getEnvType(mod) === 'server'">
                                                <span class="env-badge env-server" title="Server Side Only">
                                                    <i class="fa-solid fa-server"></i> Server
                                                </span>
                                            </template>
                                            <template x-if="getEnvType(mod) === 'both'">
                                                <span class="env-badge env-both" title="Required on Both">
                                                    <i class="fa-solid fa-network-wired"></i> Both
                                                </span>
                                            </template>
                                            <template x-if="getEnvType(mod) === 'optional'">
                                                <span class="env-badge bg-slate-700 text-slate-400 border-slate-600" title="Optional">
                                                    <i class="fa-regular fa-circle-question"></i> Opt
                                                </span>
                                            </template>

                                            <!-- –û—Ç–ª–∞–¥–∫–∞ (—É–¥–∞–ª–∏—Ç–µ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏) -->
                                            <span class="text-xs text-slate-600 font-mono" x-show="mod.client_side || mod.server_side">
                                                C:<span x-text="mod.client_side || 'none'"></span> |
                                                S:<span x-text="mod.server_side || 'none'"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- –°—Ä–µ–¥–Ω—è—è —á–∞—Å—Ç—å: —Å—Ç–∞—Ç—É—Å—ã –≤–µ—Ä—Å–∏–π -->
                                <div class="flex-1 flex items-center gap-2 justify-end">
                                    <template x-if="!mod.checked">
                                        <button @click="checkMod(mod)"
                                                class="text-xs text-slate-500 hover:text-blue-400 transition px-3 py-1 border border-slate-700 rounded hover:border-blue-500 whitespace-nowrap">
                                            <i class="fa-solid fa-circle-check"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                                        </button>
                                    </template>

                                    <template x-if="mod.checking">
                                        <div class="text-yellow-500 animate-spin text-sm">
                                            <i class="fa-solid fa-circle-notch"></i>
                                        </div>
                                    </template>

                                    <template x-if="mod.checked && !mod.checking">
                                        <div class="flex gap-1 flex-wrap justify-end">
                                            <template x-for="ver in targetVersions" :key="ver">
                                                <div class="flex items-center gap-1 px-2 py-0.5 rounded text-xs font-mono whitespace-nowrap"
                                                     :class="mod.versions && mod.versions[ver] ? 'bg-green-900/30 text-green-400 border border-green-700' : 'bg-red-900/30 text-red-400 border border-red-700'">
                                                    <span x-text="ver"></span>
                                                    <span x-text="mod.versions && mod.versions[ver] ? '‚úì' : '‚úó'"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>

                                <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
                                <button @click="cat.mods.splice(modIndex, 1); saveData()"
                                        class="text-slate-600 hover:text-red-500 transition flex-shrink-0">
                                    <i class="fa-solid fa-xmark text-lg"></i>
                                </button>
                            </div>
                        </template>

                        <div x-show="cat.mods.length === 0" class="text-center p-8 text-slate-600 italic text-sm">
                            <i class="fa-solid fa-inbox text-3xl mb-2 opacity-30"></i><br>
                            –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –º–æ–¥—ã –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫
                        </div>
                    </div>
                </div>
            </template>

            <button @click="addCategory()" class="w-full py-3 border-2 border-dashed border-slate-700 text-slate-500 rounded-xl hover:border-slate-500 hover:text-slate-300 transition">
                + –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            </button>
        </div>

        <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ü–æ–∏—Å–∫ + –ö–Ω–æ–ø–∫–∞ (Sticky, —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞) -->
        <div class="w-96 flex-shrink-0 sticky top-32">
            <div class="bg-slate-800 rounded-xl p-4 border border-slate-700 shadow-xl flex flex-col max-h-[calc(100vh-140px)]">
                <h3 class="font-bold mb-4 text-slate-400 uppercase text-xs tracking-wider">Modrinth Search</h3>

                <div class="relative flex-shrink-0">
                    <input type="text" x-model="searchQuery" @input.debounce.500ms="performSearch()"
                           placeholder="–ù–∞–π—Ç–∏ –º–æ–¥..."
                           class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none transition">
                    <i x-show="isSearching" class="fa-solid fa-spinner fa-spin absolute right-3 top-3.5 text-slate-500"></i>
                </div>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ (—Å–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏) -->
                <div class="mt-4 space-y-2 overflow-y-auto pr-1 scroll-hide flex-1 min-h-0">
                    <template x-for="result in searchResults" :key="result.slug">
                        <div class="bg-slate-900 p-3 rounded-lg border border-slate-700 hover:border-blue-500 transition group cursor-move relative"
                             draggable="true"
                             @dragstart="handleSearchDragStart($event, result)"
                             @click="addToCategory(result)">
                            <div class="flex gap-3">
                                <img :src="result.icon_url" class="w-10 h-10 rounded bg-slate-800 flex-shrink-0">
                                <div class="flex-1 min-w-0">
                                    <div class="font-bold text-sm truncate" x-text="result.title"></div>
                                    <div class="text-xs text-slate-500 line-clamp-2" x-text="result.description"></div>
                                </div>
                            </div>
                            <div class="absolute top-2 right-2 bg-blue-600 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition">
                                <i class="fa-solid fa-plus"></i>
                            </div>
                        </div>
                    </template>

                    <div x-show="searchResults.length === 0 && !isSearching && searchQuery.length > 0"
                         class="text-center text-slate-600 text-sm py-4">
                        –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ø—Ä–∏–∫–ª–µ–µ–Ω–∞ –∫ –Ω–∏–∑—É –∫–∞—Ä—Ç–æ—á–∫–∏) -->
                <div class="mt-4 pt-4 border-t border-slate-700 flex-shrink-0">
                    <button @click="checkAll()"
                            :disabled="targetVersions.length === 0 || isCheckingAll"
                            class="w-full py-3 rounded-xl font-bold transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed relative"
                            :class="targetVersions.length > 0 ? 'bg-blue-600 hover:bg-blue-500 shadow-blue-900/20' : 'bg-slate-700'">
                        <span x-show="!isCheckingAll">
                            <i class="fa-solid fa-list-check"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –í–°–ï –º–æ–¥—ã
                        </span>
                        <span x-show="isCheckingAll" class="flex items-center justify-center gap-2">
                            <i class="fa-solid fa-spinner fa-spin"></i>
                            <span x-text="checkProgress"></span>
                        </span>
                    </button>

                    <div class="text-xs text-center text-slate-500 mt-2" x-show="apiDelay > 0">
                        <i class="fa-solid fa-clock"></i> –ó–∞–¥–µ—Ä–∂–∫–∞ API: <span x-text="apiDelay"></span>–º—Å
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
