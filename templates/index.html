<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ModStacker üõ†Ô∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        [x-cloak] { display: none !important; }
        .scroll-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen font-sans"
      x-data="app()" x-init="initApp()">

    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <div class="sticky top-0 z-50 bg-slate-800 border-b border-slate-700 shadow-lg p-4">
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 text-transparent bg-clip-text">
                <i class="fa-solid fa-cube"></i> ModStacker
            </h1>

            <button @click="saveData()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-sm font-bold transition">
                <i class="fa-solid fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏—è–º–∏ -->
        <div class="flex items-center gap-3">
            <span class="text-sm text-slate-400 font-semibold">–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –≤–µ—Ä—Å–∏–∏:</span>

            <!-- –°–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏–π -->
            <div class="flex gap-2 flex-wrap items-center">
                <template x-for="(ver, idx) in targetVersions" :key="ver">
                    <div class="flex items-center gap-1 bg-blue-600 px-2 py-1 rounded text-xs font-mono">
                        <span x-text="ver"></span>
                        <button @click="removeVersion(idx)" class="ml-1 text-blue-200 hover:text-white">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </template>

                <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ -->
                <div class="flex gap-1 items-center">
                    <input type="text"
                           x-model="newVersion"
                           @keyup.enter="addVersion()"
                           placeholder="1.21.5"
                           class="w-20 bg-slate-700 border border-slate-600 rounded px-2 py-1 text-xs font-mono focus:border-blue-500 outline-none">
                    <button @click="addVersion()" class="bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-xs transition">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫ -->
            <button @click="resetChecks()" class="ml-auto text-xs text-slate-500 hover:text-slate-300 transition">
                <i class="fa-solid fa-rotate"></i> –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏
            </button>
        </div>
    </div>

    <div class="container mx-auto p-6 flex gap-6">

        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –°–ø–∏—Å–æ–∫ –º–æ–¥–æ–≤ -->
        <div class="w-2/3 space-y-6">

            <template x-for="(cat, catIndex) in data.categories" :key="catIndex">
                <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                    <div class="p-4 bg-slate-800/50 flex justify-between items-center border-b border-slate-700">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fa-solid fa-folder-open text-yellow-500"></i>
                            <input x-model="cat.name" class="bg-transparent outline-none focus:text-blue-400" placeholder="Category Name">
                        </h2>
                        <button @click="deleteCategory(catIndex)" class="text-red-500 hover:text-red-400 opacity-50 hover:opacity-100">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>

                    <!-- –°–ø–∏—Å–æ–∫ –º–æ–¥–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                    <div class="p-2 space-y-1">
                        <template x-for="(mod, modIndex) in cat.mods" :key="mod.slug">
                            <div class="group flex items-center justify-between p-3 rounded-lg hover:bg-slate-700 transition border border-transparent hover:border-slate-600">
                                <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –∏–∫–æ–Ω–∫–∞ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ -->
                                <div class="flex items-center gap-3 flex-shrink-0">
                                    <img :src="mod.icon_url || 'https://cdn.modrinth.com/user/icon/placeholder.png'" class="w-10 h-10 rounded">
                                    <div>
                                        <div class="font-bold leading-tight" x-text="mod.title"></div>
                                        <div class="text-xs text-slate-500 font-mono" x-text="mod.slug"></div>
                                    </div>
                                </div>

                                <!-- –°—Ä–µ–¥–Ω—è—è —á–∞—Å—Ç—å: —Å—Ç–∞—Ç—É—Å—ã –≤–µ—Ä—Å–∏–π -->
                                <div class="flex-1 flex items-center gap-2 justify-end mr-4">
                                    <template x-if="!mod.checked">
                                        <button @click="checkMod(mod)"
                                                class="text-xs text-slate-500 hover:text-blue-400 transition px-3 py-1 border border-slate-700 rounded hover:border-blue-500">
                                            <i class="fa-solid fa-circle-check"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                                        </button>
                                    </template>

                                    <template x-if="mod.checking">
                                        <div class="text-yellow-500 animate-spin text-sm">
                                            <i class="fa-solid fa-circle-notch"></i>
                                        </div>
                                    </template>

                                    <template x-if="mod.checked && !mod.checking">
                                        <div class="flex gap-1 flex-wrap">
                                            <template x-for="ver in targetVersions" :key="ver">
                                                <div class="flex items-center gap-1 px-2 py-0.5 rounded text-xs font-mono"
                                                     :class="mod.versions && mod.versions[ver] ? 'bg-green-900/30 text-green-400 border border-green-700' : 'bg-red-900/30 text-red-400 border border-red-700'">
                                                    <span x-text="ver"></span>
                                                    <span x-text="mod.versions && mod.versions[ver] ? '‚úì' : '‚úó'"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>

                                <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
                                <button @click="cat.mods.splice(modIndex, 1); saveData()"
                                        class="text-slate-600 hover:text-red-500 transition flex-shrink-0">
                                    <i class="fa-solid fa-xmark text-lg"></i>
                                </button>
                            </div>
                        </template>

                        <!-- –ü—É—Å—Ç–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è -->
                        <div x-show="cat.mods.length === 0" class="text-center p-4 text-slate-600 italic text-sm">
                            –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –º–æ–¥—ã –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫
                        </div>
                    </div>
                </div>
            </template>

            <button @click="addCategory()" class="w-full py-3 border-2 border-dashed border-slate-700 text-slate-500 rounded-xl hover:border-slate-500 hover:text-slate-300 transition">
                + –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            </button>
        </div>

        <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ü–æ–∏—Å–∫ -->
        <div class="w-1/3">
            <div class="sticky top-32 bg-slate-800 rounded-xl p-4 border border-slate-700 shadow-xl">
                <h3 class="font-bold mb-4 text-slate-400 uppercase text-xs tracking-wider">Modrinth Search</h3>

                <div class="relative">
                    <input type="text" x-model="searchQuery" @input.debounce.500ms="performSearch()"
                           placeholder="–ù–∞–π—Ç–∏ –º–æ–¥..."
                           class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none transition">
                    <i x-show="isSearching" class="fa-solid fa-spinner fa-spin absolute right-3 top-3.5 text-slate-500"></i>
                </div>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
                <div class="mt-4 space-y-2 max-h-[60vh] overflow-y-auto pr-1 scroll-hide">
                    <template x-for="result in searchResults" :key="result.slug">
                        <div class="bg-slate-900 p-3 rounded-lg border border-slate-700 flex gap-3 hover:border-blue-500 transition group cursor-pointer"
                             @click="addToCategory(result)">
                            <img :src="result.icon_url" class="w-10 h-10 rounded bg-slate-800">
                            <div class="flex-1">
                                <div class="font-bold text-sm" x-text="result.title"></div>
                                <div class="text-xs text-slate-500 line-clamp-1" x-text="result.description"></div>
                            </div>
                            <div class="flex items-center">
                                <i class="fa-solid fa-plus text-blue-500 opacity-0 group-hover:opacity-100 transition"></i>
                            </div>
                        </div>
                    </template>

                    <div x-show="searchResults.length === 0 && !isSearching && searchQuery.length > 0"
                         class="text-center text-slate-600 text-sm py-4">
                        –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
            <div class="mt-4">
                <button @click="checkAll()"
                        :disabled="targetVersions.length === 0"
                        class="w-full py-3 rounded-xl font-bold transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                        :class="targetVersions.length > 0 ? 'bg-blue-600 hover:bg-blue-500 shadow-blue-900/20' : 'bg-slate-700'">
                    <i class="fa-solid fa-list-check"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –í–°–ï –º–æ–¥—ã
                </button>
            </div>

            <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
            <div class="mt-4">
                <div class="text-xs text-slate-500 mb-2 uppercase font-bold">–≠–∫—Å–ø–æ—Ä—Ç (—Ç–æ–ª—å–∫–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ)</div>
                <textarea readonly
                          class="w-full h-32 bg-slate-800 rounded-xl p-3 text-xs font-mono text-slate-400 border border-slate-700 resize-none focus:border-blue-500 outline-none"
                          @click="$el.select()"
                          x-text="exportList()"></textarea>
            </div>
        </div>
    </div>

    <!-- JS LOGIC -->
    <script>
        function app() {
            return {
                data: { categories: [] },
                searchQuery: '',
                searchResults: [],
                isSearching: false,
                targetVersions: ['1.21.1', '1.21.2', '1.21.3', '1.21.4'], // –ù–∞—á–∞–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏
                newVersion: '',

                async initApp() {
                    const resp = await fetch('/api/data');
                    this.data = await resp.json();

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (this.data.targetVersions) {
                        this.targetVersions = this.data.targetVersions;
                    }
                },

                addVersion() {
                    const ver = this.newVersion.trim();
                    if (!ver) return;

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.21.5)
                    if (!/^\d+\.\d+(\.\d+)?$/.test(ver)) {
                        alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–µ—Ä—Å–∏–∏! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: 1.21.5');
                        return;
                    }

                    if (this.targetVersions.includes(ver)) {
                        alert('–≠—Ç–∞ –≤–µ—Ä—Å–∏—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                        return;
                    }

                    this.targetVersions.push(ver);
                    this.newVersion = '';
                    this.resetChecks(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–µ—Ä—Å–∏–π
                    this.saveData();
                },

                removeVersion(idx) {
                    this.targetVersions.splice(idx, 1);
                    this.resetChecks();
                    this.saveData();
                },

                async performSearch() {
                    if (this.searchQuery.length < 2) {
                        this.searchResults = [];
                        return;
                    }
                    this.isSearching = true;
                    const resp = await fetch(`/api/search?q=${encodeURIComponent(this.searchQuery)}`);
                    this.searchResults = await resp.json();
                    this.isSearching = false;
                },

                addCategory() {
                    this.data.categories.push({ name: 'New Category', mods: [] });
                    this.saveData();
                },

                deleteCategory(idx) {
                    if(confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) {
                        this.data.categories.splice(idx, 1);
                        this.saveData();
                    }
                },

                addToCategory(mod) {
                    if (this.data.categories.length === 0) this.addCategory();

                    const exists = this.data.categories.some(c => c.mods.some(m => m.slug === mod.slug));
                    if (exists) {
                        alert('–≠—Ç–æ—Ç –º–æ–¥ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω!');
                        return;
                    }

                    this.data.categories[0].mods.push({
                        title: mod.title,
                        slug: mod.slug,
                        icon_url: mod.icon_url,
                        checked: false,
                        versions: {}, // –û–±—ä–µ–∫—Ç –≤–∏–¥–∞ {"1.21.1": true, "1.21.2": false}
                        checking: false
                    });

                    this.searchQuery = '';
                    this.searchResults = [];

                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–π –º–æ–¥
                    const addedMod = this.data.categories[0].mods[this.data.categories[0].mods.length - 1];
                    this.checkMod(addedMod);
                },

                async checkMod(mod) {
                    if (this.targetVersions.length === 0) {
                        alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≤–µ—Ä—Å–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏');
                        return;
                    }

                    mod.checking = true;

                    try {
                        const resp = await fetch('/api/check_version', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                slug: mod.slug,
                                versions: this.targetVersions
                            })
                        });
                        const result = await resp.json();

                        mod.versions = result; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç {"1.21.1": true, ...}
                        mod.checked = true;
                    } catch (e) {
                        console.error('Error checking mod:', e);
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –º–æ–¥–∞ ' + mod.title);
                    } finally {
                        mod.checking = false;
                        this.saveData();
                    }
                },

                async checkAll() {
                    if (this.targetVersions.length === 0) {
                        alert('–î–æ–±–∞–≤—å—Ç–µ –≤–µ—Ä—Å–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏');
                        return;
                    }

                    for (let cat of this.data.categories) {
                        for (let mod of cat.mods) {
                            await this.checkMod(mod);
                            await new Promise(r => setTimeout(r, 150)); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
                        }
                    }
                },

                resetChecks() {
                    this.data.categories.forEach(c => c.mods.forEach(m => {
                        m.checked = false;
                        m.versions = {};
                    }));
                    this.saveData();
                },

                async saveData() {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –≤–µ—Ä—Å–∏–∏ —Ç–æ–∂–µ
                    const payload = {
                        ...this.data,
                        targetVersions: this.targetVersions
                    };

                    await fetch('/api/save', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                },

                exportList() {
                    if (this.targetVersions.length === 0) {
                        return "–î–æ–±–∞–≤—å—Ç–µ –≤–µ—Ä—Å–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏...";
                    }

                    let text = "";
                    this.data.categories.forEach(cat => {
                        cat.mods.forEach(mod => {
                            // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –≤–µ—Ä—Å–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
                            if (mod.checked && mod.versions) {
                                const hasSupport = Object.values(mod.versions).some(v => v === true);
                                if (hasSupport) {
                                    text += `https://modrinth.com/mod/${mod.slug}\n`;
                                }
                            }
                        });
                    });

                    return text || "–°–ø–∏—Å–æ–∫ —Å—Å—ã–ª–æ–∫ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–¥–æ–≤...";
                }
            }
        }
    </script>
</body>
</html>
